config-type: rule
id: "trivy-verify-vulnerability-findings"
name: "Trivy Vulnerability Findings Check"
path: "verify-cve-severity.rego"
help: https://scribe-security.netlify.app/docs/valint/generic#trivy-integration-example

description: |
  Verifies that vulnerability findings in the SARIF evidence from Trivy do not exceed
  the defined severity threshold.

full-description: |  
  This rule processes the SARIF report produced by the Trivy Vulnerability Scanner to verify that it 
  complies with a set of predefined rules. The evaluation is based on several configurable parameters:
  
  The rule iterates over the vulnerability results in the SARIF report (provided under 
  `input.evidence.predicate.content.runs[0].results`), and for each result, it retrieves the corresponding 
  rule definition from `input.evidence.predicate.content.runs[0].tool.driver.rules` based on the result's 
  ruleIndex. It then evaluates whether the severity (extracted from the ruleâ€™s properties) exceeds the specified 
  threshold. If the number of such violations exceeds the allowed maximum, a violation is recorded.
  
  ### **Evidence Requirements**
  
  - Evidence must be provided in a generic format adhering to the SARIF 2.1.0 schema.
  - The SARIF report should be generated by the "Trivy Vulnerability Scanner".
  
mitigation: >
  Ensures that the SARIF report generated by Trivy meets the predefined security criteria,
  helping to detect critical vulnerabilities and configuration issues early.

inputs:
  - name: severity_threshold
    type: integer
    description: The maximum severity level allowed for vulnerabilities.
    required: true

input_example: |
  severity_threshold: 0

labels:
  - "SARIF"
  - "Trivy"

fail-on-missing-evidence: true

evidence:
  signed: false
  content_body_type: generic
  target_type: data
  predicate_type: "http://docs.oasis-open.org/sarif/sarif/2.1.0"
  tool: "Trivy Vulnerability Scanner"
  filter-by:
    - product

with:
  severity_threshold: 0

