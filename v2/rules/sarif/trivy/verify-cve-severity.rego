package verify

import future.keywords.in
import data.scribe as scribe

default allow := false
default violations := []
default asset := {}

asset = scribe.get_asset_data(input.evidence)

# Override default severity threshold if provided
default severity_threshold := 2
severity_threshold = input.config.args.severity_threshold

default reason := "No security severity violations detected."

##########################################################################
# Final Verify Object
##########################################################################
verify = result {
  result := {
    "allow": allow,
    "violation": {
      "type": "CVE threshold violations",
      "details": violations,
    },
    "asset": asset,
    "summary": [{
      "allow": allow,
      "reason": reason,
      "violations": count(violations)
    }]
  }
}

##########################################################################
# Decision Logic
##########################################################################
allow {
  count(violations) == 0
}

##########################################################################
# Reason for Summary
##########################################################################
reason = msg {
  allow
  msg := "All SARIF results are within the acceptable security severity threshold."
}
reason = msg {
  not allow
  msg := sprintf("Found %d vulnerabilities exceeding the threshold of %d: %v", 
                 [count(violations), severity_threshold, extract_cves(violations)])
}

##########################################################################
# Evaluate Violations Based on Severity Threshold
##########################################################################
violations = results {
  results := [ v |
    run_result := input.evidence.predicate.content.runs[0].results[_]
    rule_def   := input.evidence.predicate.content.runs[0].tool.driver.rules[run_result.ruleIndex]
    get_security_severity(rule_def) > severity_threshold
    v := {
      "rule": run_result.ruleId,
      "severity": get_security_severity(rule_def),
      "location": run_result.locations[0].physicalLocation.artifactLocation.uri,
    }
  ]
} else = results {
  results := []
}

##########################################################################
# Helper Function: Extract Security Severity
##########################################################################
get_security_severity(rule) = severity {
  severity := to_number(rule.properties["security-severity"])
}

##########################################################################
# Helper Function: Extract CVE Identifiers from Violations
##########################################################################
extract_cves(violations) = cves {
  cves := [ v.rule | v := violations[_] ]
}
