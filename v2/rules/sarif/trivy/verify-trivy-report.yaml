config-type: rule
id: trivy-report
name: Verify Trivy SARIF Report Compliance
path: ../verify-sarif.rego
help: https://scribe-security.netlify.app/docs/valint/generic#trivy-integration-example

description: Verify the Trivy SARIF report complies with predefined rules to ensure compliance and detect issues.

full-description: |-  
  This rule processes the SARIF report produced by the Trivy Vulnerability Scanner to verify that it 
  complies with a set of predefined rules. The evaluation is based on several configurable parameters:
  
  The rule iterates over the vulnerability results in the SARIF report (provided under 
  `input.evidence.predicate.content.runs[0].results`), and for each result, it retrieves the corresponding 
  rule definition from `input.evidence.predicate.content.runs[0].tool.driver.rules` based on the result's 
  ruleIndex. It then evaluates whether the severity (extracted from the ruleâ€™s properties) exceeds the specified 
  threshold. If the number of such violations exceeds the allowed maximum, a violation is recorded.
  
  ### **Evidence Requirements**
  
  - Evidence must be provided in a generic format adhering to the SARIF 2.1.0 schema.
  - The SARIF report should be generated by the "Trivy Vulnerability Scanner".
  - The evidence must include proper filtering based on the product as defined in the configuration.

mitigation: >-
  Ensures that the SARIF report generated by Trivy meets the predefined security criteria,
  helping to detect critical vulnerabilities and configuration issues early.

inputs:
  - name: rule_level
    type: array
    description: List of rule levels to check for in the Trivy SARIF report.
    required: false
  - name: precision
    type: array
    description: List of precision levels to check for in the Trivy SARIF report.
    required: false
  - name: rule_ids
    type: array
    description: List of rule IDs to check for in the Trivy SARIF report.
    required: false
  - name: rule_names
    type: array
    description: List of rule names to check for in the Trivy SARIF report.
    required: false
  - name: ignore
    type: array
    description: List of rule IDs to ignore in the Trivy SARIF report.
    required: false
  - name: max_allowed
    type: integer
    description: The maximum number of allowed violations.
    required: false

labels:
  - SARIF
  - Trivy

evidence:
  signed: false
  content_body_type: generic
  target_type: data
  predicate_type: "http://docs.oasis-open.org/sarif/sarif/2.1.0"
  tool: "Trivy Vulnerability Scanner"
  filter-by:
    - product
    
with:
  rule_level: []
  precision: []
  rule_ids: []
  rule_names: []
  ignore: []
  max_allowed: 0
