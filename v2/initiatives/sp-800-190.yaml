config-type: initiative
id: "SP-800-190"
version: "1.0.0"
name: "NIST Application Container Security Initiative"
description: >
  Enforces container security rules derived from NIST SP 800-190. 
  Includes additional license compliance checks aligned with SPDX
  to ensure both technical (CVE, configuration) and legal (license) risks 
  are mitigated within the container supply chain.
help: "https://csrc.nist.gov/publications/detail/sp/800-190/final"

defaults:
  evidence:
    signed: false

controls:

  ########################################################################
  # CONTROL 1: IMAGE COUNTERMEASURES (4.1)
  ########################################################################
  - name: "4.1 IMAGE-COUNTERMEASURES"
    description: "4.1 Image Countermeasures"
    mitigation: >
      Enforce fresh, trusted base images; scan for vulnerabilities; 
      and apply secure configuration to reduce attack surface 
      per SP 800-190 Section 4.1.
    rules:

      # ------------------------------------------------------------------
      # 4.1.5 Use of trusted base images
      # ------------------------------------------------------------------
      - uses: images/allowed-base-image@v2/rules
        name: "4.1.5 Approved Source Base Images"
        description: "4.1.5 Use of trusted base images"
        with:
          approved_sources:
            # - "index.docker.io/library/python.*slim"
            # - "index.docker.io/library/my_company/base.*"

      # ------------------------------------------------------------------
      # 4.1.5 Use of trusted images
      # ------------------------------------------------------------------
      # TBD
      - uses: images/allowed-image-source@v2/rules
        name: "4.1.5 Approved Source Images"
        description: "4.1.5 Use of trusted images"
        with:
          approved_sources:
            # - "index.docker.io/library/nginx:.*"
            # - "index.docker.io/library/my_company/.*"
 
      - uses: images/image-signed@v2/rules
        name: "4.1.5 Signed Images"
        description: "4.1.5 Use of trusted images (signed)"
        with:
          #skip_image_regex:
            #- "index.docker.io/library/nginx:.*"
          # identity:
          #   emails: []
          #   common-names: []

      # ------------------------------------------------------------------
      # 4.1.1 Image Vulnerabilities
      # ------------------------------------------------------------------
      - uses: api/scribe-api-cve@v2/rules
        name: "4.1.1 Vulnerability Scan (CVE Severity)"
        description: >
          4.1.1 Image Vulnerabilities (Scribe):
          Scan for CVEs; block if severity >= 6 (high).
        with:
          superset:
            cve:
              severity: 6
              max: 0

      # TBD
      # - name: "High-Profile Vulnerabilities (Scribe)"
      #   uses: api/blocklist-scribe-api-cve@v2/rules
      #   description: "4.1.1 Blocklist of Specific CVEs"
      #   with:
      #     cves:
      #       - "CVE-2014-0160"
      #       - "CVE-2021-44228"
      #       - "CVE-2023-38545"
      #       - "CVE-2023-44487"
      #       - "CVE-2024-3094"
      #       - "CVE-2024-47176"
      #       - "CVE-2024-47076"
      #       - "CVE-2024-47175"
      #       - "CVE-2024-47177"

      # ------------------------------------------------------------------
      # 4.1.2 Image Configuration Defects
      # ------------------------------------------------------------------
      # 2DO (imp by scout demo)
      - name: "4.1.2 Default Non-Root User"
        uses: images/banned-users@v2/rules
        description: >
          4.1.2 Image Configuration Defects:
          Ensure container doesnâ€™t run as 'root'.
        mitigation: "Block usage of root user in final image."

      # 2DO
      - name: "4.1.2 Banned Open Port 22"
        uses: images/banned-ports@v2/rules
        description: >
          4.1.2 Image Configuration Defects:
          Confirm that port 22 is not exposed in Dockerfile.
        mitigation: "Block usage of SSH in container base image."

      # ------------------------------------------------------------------
      # 4.1.3 Labeled Here for Healthcheck (User-labeled mismatch)
      # ------------------------------------------------------------------
      # 2DO
      - name: "4.1.3 Set HEALTHCHECK Instruction"
        uses: images/require-healthcheck@v2/rules
        description: >
          4.1.3 Image Configuration Defects (mismatch with official doc):
          Ensure a HEALTHCHECK is defined for Dockerfile.
        mitigation: "Add HEALTHCHECK to detect container health issues."

      - uses: images/verify-labels@v2/rules
        name: "Verify Required Image Labels"
        description: >
          Ensure that container images include mandatory labels:
          'org.opencontainers.image.created',
          'org.opencontainers.image.revision',
          'org.opencontainers.image.source',
          'org.opencontainers.image.version',
          'org.opencontainers.image.licenses'.
        mitigation: "Reject images with missing or inconsistent metadata labels."
        with:
          labels:
            - "org.opencontainers.image.created"
            - "org.opencontainers.image.revision"
            - "org.opencontainers.image.source"
            - "org.opencontainers.image.version"
            - "org.opencontainers.image.licenses"


  ########################################################################
  # CONTROL 2: REGISTRY COUNTERMEASURES (4.2)
  ########################################################################
  - name: "4.2 REGISTRY COUNTERMEASURES"
    description: "4.2 Registry Countermeasures"
    mitigation: "Ensure that base or derived images are fresh and not stale."
    rules:

      - name: "4.2.1 Registry Connection Enforcement"
        rules:
          - uses: images/enforce-https-registry@v1/rules
            name: "Require HTTPS Registry Scheme"
            description: "Checks if the image's registry transport is 'https'."

      - uses: images/fresh-base-image@v2/rules
        name: "4.2.2 Up-to-Date Base Images"
        description: "4.2.2 Up-to-Date Base Images (Check base image age)"
        with:
          max_days: 100

      - uses: images/fresh-image@v2/rules
        name: "4.2.2 Up-to-Date Derived Images"
        description: "4.2.2 Up-to-Date Images (Check derived image age)"
        with:
          max_days: 30

