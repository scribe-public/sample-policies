attest:
  cocosign:
    policies:
    - name: sbom-policy
      enable: true
      modules:
      - name: complete-licenses
        type: verify-artifact
        enable: true
        input:
          signed: false
          format: statement-cyclonedx-json
          match:
            target_type: image
          rego:
                script: |
                  package verify

                  default allow = false
                  default violations = []
                  
                  verify = v {
                          v := {
                          "allow": allow,
                          "violations": violations,
                              "summary": [{
                              "allow": allow,
                              "reason":  "Not all packages have licenses",
                              "details": json.marshal(violations),
                              "violations": count(violations),
                          }]
                      }
                  }

                  allow {
                    count(violations) == 0
                  }

                  violations = j {
                    j := { r |
                        components := input.evidence.predicate.bom.components
                        some i 
                        comp := components[i]
                        comp.licenses != null
                        r = {
                          "type":"license",
                          "details": {
                            "package":comp.purl,
                          }
                        }
                      }
                  }

